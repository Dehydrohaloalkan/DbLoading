# 2. Требования (Requirements)

## 2.1. Функциональные требования (FR)

### FR-01. Логин и аутентификация

- Пользователь вводит:
  - DB2 username
  - DB2 password
  - DB (dropdown)
  - manager (dropdown)
  - stream (dropdown)
- Сервер пытается выполнить проверку логина через подключение к DB2.
- При успехе:
  - выдаётся **JWT access token** (TTL 20 минут)
  - выдаётся **refresh token** (TTL 4 часа) в **HttpOnly cookie**
- Пользователь получает доступ к основному экрану.

### FR-02. Отображение пользователя и выход

- В верхней панели:
  - слева — название приложения
  - справа — логин, manager, stream, база
  - кнопка “Выйти”
- Выход:
  - отзывает refresh token (если активен)
  - очищает client state

### FR-03. Просмотр групп/скриптов и выбор

- Скрипты распределены по фиксированным группам (вкладки/таб).
- Внутри группы пользователь может включить/отключить конкретные **логические скрипты** для запуска.
- Пользователь запускает:
  - одну группу (запускаются отмеченные в группе)
  - все группы (запускаются отмеченные в каждой группе)
- Пользователь не запускает “варианты” отдельно и не видит их в UI.

### FR-04. Модификация SELECT

Для каждого логического скрипта можно выбрать режим:

- **Default**: выполнять SQL как есть (возвращает одну колонку `"LineFile"` — готовая строка).
- **Custom columns**: пользователь выбирает колоноки/выражения (из конфига для данного логического скрипта), а приложение:
  - парсит SQL,
  - **полностью заменяет** `SELECT "LineFile"` на `SELECT <expr1> || '|' || <expr2> ...` (или эквивалент),
  - дополнительно применяет экранирование и правила преобразования (см. `06-config-format.md`).

### FR-05. Выполнение скриптов (3 варианта)

- Один логический скрипт состоит из **трёх SQL файлов** (вариантов), выполняемых вместе.
- Результаты каждого варианта сохраняются **в отдельные файлы**.
- Если вариант возвращает 0 строк — файлов не создаётся, статус `NoData` (для варианта/или агрегированно для скрипта — см. `07-api-contract.md`).

### FR-06. Выгрузка на диск и нарезка

- Результаты сохраняются на стороне сервера в директории `OutputRoot` (из конфига).
- Структура по умолчанию:
  - `OutputRoot/<runId>/<group>/<script>/<variant>/part-0001.txt`
- Максимальный размер файла: **10 MiB** (= 10 * 1024 * 1024 байт) по фактическим байтам в выбранной кодировке.
- Строка **не разрывается** между файлами.
- Файл **не превышает** 10 MiB:
  - если очередная строка “не влезает” — строка пишется в следующий файл.
  - если *одна* строка уже больше лимита — поведение задаётся конфигом (по умолчанию: ошибка выполнения варианта).

### FR-07. Очистка старых данных

- Перед новым запуском (run) сервер очищает `OutputRoot`:
  - удаляет результаты предыдущего успешного запуска (конфигурируемо, по умолчанию — очищать перед стартом).
- При ошибке выполнения — результаты **не очищаются** автоматически (чтобы пользователь мог посмотреть, что успело выгрузиться), если не указано иначе.

### FR-08. Параллелизм и “потоки”

- Есть **N** потоков выполнения SQL (worker’ов), задаётся конфигом.
- Для каждого логического скрипта в конфиге задан `executionLane` (0..N-1).
- Внутри одного `executionLane` скрипты выполняются **последовательно**.
- Потоки нарезки файлов/стриминга — **отдельные**, не учитываются в N.

### FR-09. Статусы/прогресс и синхронизация

- Клиент видит статусы выполнения для групп/скриптов:
  - `Queued`, `Running`, `Success`, `NoData`, `Failed`, `Cancelled`
- Клиент получает обновления прогресса через **SignalR**.
- UI использует иконки + текст (PrimeNG).

### FR-10. Заглушка stream (на будущее)

- После нарезки файлы могут быть переданы на запись во внешний stream:
  - на текущей версии — заглушка (контракт + интерфейсы)
  - архитектурно предполагается **гарантированная доставка**: “сначала диск → затем поток → затем удаление локальных файлов”.

### FR-11. Observer/расширяемость

Нужны события наблюдателя:

- на запуск логического скрипта
- на запуск группы
- на запуск “всех групп”
- на окончание работы (после выгрузки/нарезки)

Должна быть возможность “подвесить” дополнительные обработчики без переписывания основного кода (см. `10-observer-events.md`).

## 2.2. Нефункциональные требования (NFR)

- **Кроссплатформенность сервера**: Linux/Windows.
- **Безопасность**:
  - refresh token — HttpOnly cookie
  - возможность отзыва токенов для конкретного пользователя
  - DB2 пароль не хранится в JWT/логах; хранение учётки — только в памяти на сервере.
- **Надёжность**:
  - ошибка при записи в stream не должна приводить к потере выгрузки (пока файлы на диске — можно повторить).
- **Управляемость**:
  - конфиги в отдельной папке (не засорять корень)
  - расширяемые правила экранирования/кодировки
- **UX**:
  - понятная индикация статусов
  - защита от запуска в “неправильном состоянии” (например, при незалогиненном пользователе)

