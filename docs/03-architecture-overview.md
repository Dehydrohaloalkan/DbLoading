# 3. Архитектура (Overview)

## 3.1. Компоненты

Система состоит из двух приложений:

- **Backend**: .NET 10 (ASP.NET Core) — API, аутентификация, выполнение SQL, выгрузка/нарезка, SignalR, наблюдатели, заглушка stream.
- **Frontend**: Angular 21 + PrimeNG 21 — UI логина, выбор групп/скриптов, выбор колонок, отображение статусов/прогресса.

DB2 — внешняя зависимость, не часть системы (но используется для аутентификации и выгрузки).

## 3.2. Архитектурный стиль

Один монолитный backend‑сервис (без микросервисов), с логическим разбиением по слоям:

- **API слой** (Controllers, DTO, validation)
- **Application слой** (use‑cases: login, start run, query status, cancel, refresh token)
- **Domain слой** (модели Script/Group/Run/JobStatus, события, observer)
- **Infrastructure слой** (DB2 provider (пока заглушка), filesystem writer, slicer, token store, stream sink (заглушка), SignalR broadcasting)

## 3.3. Потоки данных (высокоуровнево)

1. Пользователь логинится → backend проверяет DB2 соединение → выдаёт токены.
2. Клиент запрашивает конфиг групп/скриптов/колонок → рендерит UI.
3. Пользователь выбирает группы/скрипты и режим модификации → “Start run”.
4. Backend создаёт `runId`, очищает output (по политике), ставит работы в очереди по `executionLane`.
5. Worker’ы выполняют варианты SQL:
   - читают строки результата (LineFile или склейка)
   - пишут в staging, нарезают на 10 MiB
6. Backend пушит прогресс в SignalR.
7. (Будущее) Stream writer читает готовые файлы, пишет в stream, удаляет локально при подтверждении.

## 3.4. Основные сущности

- **Group**: логическая вкладка (имя, список ScriptRef).
- **Script**: логический скрипт (id, displayName, executionLane, variants[3], selectableColumns, defaults).
- **Variant**: один SQL файл, выполняется как часть Script.
- **Run**: один запуск пользователем; содержит snapshot выбора (какие группы/скрипты включены, режимы модификации), статусы.

## 3.5. Почему SignalR

Скрипты могут выполняться долго; polling будет работать, но:

- SignalR даёт более “живой” UI без лишнего трафика
- проще показывать прогресс/смену статусов
- всё запускается в одном backend (без микросервисов)

## 3.6. Решения по безопасности (коротко)

- Access token 20 мин, refresh token 4 часа.
- Refresh хранится в HttpOnly cookie.
- Хранилище refresh — in‑memory (по требованию); при рестарте сервера потребуется заново логиниться.
- DB2 учётные данные хранятся только в памяти на время сессии.

Подробности — `08-security-auth.md`.

